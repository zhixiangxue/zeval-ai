# Zeval æ¡†æ¶æ ¸å¿ƒè®¾è®¡æ€æƒ³

æœ¬æ–‡æ¡£æ€»ç»“äº† zeval æ¡†æ¶çš„æ ¸å¿ƒè®¾è®¡ç†å¿µå’Œæ¶æ„æ€æƒ³ã€‚

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€æƒ³

### 1. ç«¯åˆ°ç«¯çš„ RAG è¯„ä¼°é—­ç¯

zeval æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ **"åˆæˆæ•°æ® â†’ è¯„ä¼° â†’ åˆ†æ"** é—­ç¯ï¼š

- **åˆæˆæ•°æ®ç”Ÿæˆ**ï¼šä»åŸå§‹æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆå¸¦ ground truth çš„è¯„ä¼°æ•°æ®é›†
- **çœŸå®è¯„ä¼°**ï¼šè®©å¾…æµ‹ RAG ç³»ç»Ÿå¤„ç†é—®é¢˜ï¼Œæ”¶é›†ç­”æ¡ˆå’Œæ£€ç´¢ä¸Šä¸‹æ–‡
- **è‡ªåŠ¨åŒ–æŠ¥å‘Š**ï¼šåŸºäºå¤šæŒ‡æ ‡è¯„ä¼°ï¼Œç”Ÿæˆæ´å¯ŸæŠ¥å‘Šå¹¶ç»™å‡ºæ”¹è¿›å»ºè®®

å®Œæ•´æµç¨‹ï¼š

```
PDF/æ–‡æ¡£ â†’ Read (DoclingReader) 
        â†’ Split (MarkdownHeaderSplitter) 
        â†’ Transform (SummaryExtractor/KeyphrasesExtractor/EntitiesExtractor)
        â†’ Generate (generate_personas â†’ generate_single_hop/multi_hop)
        â†’ Evaluate (MetricRunner)
        â†’ Report (EvaluationReporter)
```

### 2. Self-Contained æ•°æ®ç»“æ„

`EvalCase` çš„è®¾è®¡ç†å¿µæ˜¯ **"è‡ªåŒ…å«ï¼Œæ— å¤–éƒ¨ä¾èµ–"**ï¼š

```python
class EvalCase:
    # ç”Ÿæˆé˜¶æ®µå¡«å……
    question: str
    ground_truth_answer: str
    ground_truth_contexts: list[str]
    
    # è¯„ä¼°é˜¶æ®µå¡«å……
    answer: str | None
    retrieved_contexts: list[str] | None
    
    # å¯è¿½æº¯æ€§ï¼šå­˜å‚¨å®Œæ•´æ•°æ®ï¼Œè€Œéä»… ID
    source_units: list[dict[str, Any]]
    persona: dict[str, Any] | None
    generation_params: dict[str, Any]
    
    # è¯„ä¼°ç»“æœ
    results: dict[str, EvalResult]
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- âœ… æ•°æ®é›†å¯ç‹¬ç«‹å­˜å‚¨ã€ä¼ è¾“ã€å¤ç°
- âœ… æ— éœ€ç»´æŠ¤å¤–éƒ¨ç´¢å¼•æˆ–æ•°æ®åº“
- âœ… è¯„ä¼°ç»“æœä¸åŸå§‹æ•°æ®ç»‘å®šï¼Œä¾¿äºåˆ†æ
- âœ… å®Œæ•´çš„å¯è¿½æº¯æ€§ï¼ˆä»æºæ–‡æ¡£åˆ°è¯„ä¼°ç»“æœï¼‰

### 3. Pipeline å¼æµç¨‹ç¼–æ’

æ¯ä¸ªç¯èŠ‚èŒè´£å•ä¸€ï¼Œè¾“å‡ºæ ‡å‡†æ•°æ®ç»“æ„ï¼Œä¾›ä¸‹æ¸¸ä½¿ç”¨ï¼š

| é˜¶æ®µ | è¾“å…¥ | è¾“å‡º | èŒè´£ |
|------|------|------|------|
| **Read** | PDF/æ–‡æ¡£æ–‡ä»¶ | `Document` | è§£ææ–‡æ¡£å†…å®¹å’Œç»“æ„ |
| **Split** | `Document` | `list[BaseUnit]` | æŒ‰è¯­ä¹‰åˆ‡åˆ†ä¸ºè¯„ä¼°å•å…ƒ |
| **Transform** | `list[BaseUnit]` | å¯ŒåŒ–çš„ `list[BaseUnit]` | æå–æ‘˜è¦ã€å…³é”®è¯ã€å®ä½“ |
| **Generate** | Units + Personas | `EvalDataset` | ç”Ÿæˆ Q&A è¯„ä¼°æ•°æ®é›† |
| **Evaluate** | Dataset + RAGç³»ç»Ÿ | å¸¦ç»“æœçš„ `EvalDataset` | è¿è¡Œå¤šæŒ‡æ ‡è¯„ä¼° |
| **Report** | è¯„ä¼°åçš„ Dataset | Markdown/Excel | ç”Ÿæˆåˆ†ææŠ¥å‘Š |

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- æ¨¡å—åŒ–ï¼šæ¯ä¸ªç¯èŠ‚å¯ç‹¬ç«‹æ›¿æ¢æˆ–æ‰©å±•
- å¯æµ‹è¯•ï¼šæ¯ä¸ªé˜¶æ®µå¯å•ç‹¬æµ‹è¯•
- çµæ´»æ€§ï¼šæ”¯æŒè‡ªå®šä¹‰ Reader/Splitter/Extractor/Filter/Persona

### 4. Persona é©±åŠ¨çš„åœºæ™¯åŒ–ç”Ÿæˆ

#### ç”Ÿæˆç­–ç•¥

ä½¿ç”¨ **å•å…ƒ Ã— ä¸»é¢˜ Ã— è§’è‰²** çš„ç»„åˆç­–ç•¥ï¼š

```python
def prepare_scenarios(units, personas, num_scenarios):
    # 1. ç”Ÿæˆæ‰€æœ‰å¯èƒ½ç»„åˆ
    for unit in units:
        for theme in (unit.keyphrases + unit.entities):
            for persona in personas:
                combinations.append((unit, theme, persona))
    
    # 2. éšæœºæ‰“ä¹±
    random.shuffle(combinations)
    
    # 3. åº”ç”¨çº¦æŸé‡‡æ ·
    #    - æ¯ä¸ªå•å…ƒæœ€å¤š 2 ä¸ªé—®é¢˜
    #    - è§’è‰²å‡è¡¡åˆ†å¸ƒ
    #    - ä¼˜å…ˆå”¯ä¸€ (unit, persona) é…å¯¹
```

#### ä¸¥æ ¼çº¦æŸ

- **é¿å…é‡å¤**ï¼šæ¯ä¸ªå•å…ƒæœ€å¤šç”Ÿæˆ 2 ä¸ªé—®é¢˜ï¼Œé¿å…"ä»€ä¹ˆæ˜¯ DTIï¼Ÿ"é‡å¤å‡ºç°
- **è§’è‰²å¹³è¡¡**ï¼šç¡®ä¿æ¯ä¸ª persona å‚ä¸ç”Ÿæˆçš„é—®é¢˜æ•°é‡æ¥è¿‘
- **ä¸»é¢˜å¯¹é½**ï¼šä» keyphrases/entities æå–ä¸»é¢˜ï¼Œç¡®ä¿é—®é¢˜èšç„¦

#### é¢†åŸŸå®šåˆ¶åŒ–

æ”¯æŒè‡ªå®šä¹‰ Persona å­ç±»ï¼Œæ·»åŠ ä¸šåŠ¡ç‰¹å®šå­—æ®µï¼š

```python
class HomeBuyerPersona(Persona):
    """ç¾å›½è´­æˆ¿è€…è§’è‰²"""
    credit_score: int              # ä¿¡ç”¨è¯„åˆ†
    dti_ratio: float              # å€ºåŠ¡æ”¶å…¥æ¯”
    down_payment_percent: float   # é¦–ä»˜æ¯”ä¾‹
    budget_range: str             # é¢„ç®—åŒºé—´
```

ç”Ÿæˆçš„é—®é¢˜ä¼šå¥‘åˆè¿™äº›è§’è‰²å±æ€§ï¼Œäº§ç”ŸçœŸå®ä¸šåŠ¡åœºæ™¯çš„é—®é¢˜ã€‚

### 5. å¤šæŒ‡æ ‡è¯„ä¼°çŸ©é˜µ

é‡‡ç”¨ **å…­ç»´åº¦æŒ‡æ ‡** å…¨é¢è¯Šæ–­ RAG ç³»ç»Ÿï¼š

#### æ£€ç´¢è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯„ä¼°å†…å®¹ | æ”¹è¿›æ–¹å‘ |
|------|----------|----------|
| **context_relevance** | æ£€ç´¢å†…å®¹ä¸é—®é¢˜çš„ç›¸å…³æ€§ | ä¼˜åŒ–æ£€ç´¢ç®—æ³•ã€æŸ¥è¯¢æ”¹å†™ |
| **context_recall** | Ground truth ä¿¡æ¯çš„å¬å›ç‡ | å¢åŠ  top-kã€ä¼˜åŒ–åˆ†å—ç­–ç•¥ |
| **context_precision** | æœ‰ç”¨å†…å®¹çš„æ’åºè´¨é‡ | æ·»åŠ é‡æ’åºæ¨¡å‹ |

#### ç”Ÿæˆè´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯„ä¼°å†…å®¹ | æ”¹è¿›æ–¹å‘ |
|------|----------|----------|
| **faithfulness** | ç­”æ¡ˆæ˜¯å¦å¿ å®äºæ£€ç´¢å†…å®¹ | ä¼˜åŒ– promptã€å‡å°‘å¹»è§‰ |
| **answer_relevancy** | ç­”æ¡ˆæ˜¯å¦åˆ‡é¢˜ã€èšç„¦ | å¼ºè°ƒç›´æ¥å›ç­”ã€é¿å…å†—ä½™ |
| **answer_correctness** | ç­”æ¡ˆçš„äº‹å®æ­£ç¡®æ€§ | ç»¼åˆæå‡æ£€ç´¢å’Œç”Ÿæˆè´¨é‡ |

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- è¦†ç›– RAG ç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒèƒ½åŠ›ï¼ˆæ£€ç´¢ + ç”Ÿæˆï¼‰
- å¯å¿«é€Ÿå®šä½é—®é¢˜ç¯èŠ‚ï¼ˆæ˜¯æ£€ç´¢ä¸å‡†è¿˜æ˜¯ç”Ÿæˆæœ‰é—®é¢˜ï¼Ÿï¼‰
- æŒ‡æ ‡é—´æœ‰é€»è¾‘å…³è”ï¼ˆå¦‚ context_recall ä½ä¼šå½±å“ answer_correctnessï¼‰

### 6. LLM-as-Judge + ç»“æ„åŒ–è¾“å‡º

#### è¯„ä¼°èŒƒå¼

ä½¿ç”¨ LLM ä½œä¸ºè¯„åˆ¤å‘˜ï¼Œé€šè¿‡ç»“æ„åŒ–è¾“å‡ºä¿è¯ä¸€è‡´æ€§ï¼š

```python
# å®šä¹‰è¯„ä¼°ç»“æœç»“æ„
class FaithfulnessResult(BaseModel):
    statements: list[str]
    verdicts: list[bool]
    reason: str

# ä½¿ç”¨ returns å‚æ•°ç¡®ä¿ç»“æ„åŒ–
result = await conv.asend(prompt, returns=FaithfulnessResult)
```

#### æŠ¥å‘Šç”Ÿæˆ

ä½¿ç”¨ LLM ç”Ÿæˆæ´å¯Ÿå’Œå»ºè®®ï¼š

```python
class ExecutiveSummary(BaseModel):
    overall_assessment: str                # æ€»ä½“è¯„ä¼°
    key_findings: list[str]               # å…³é”®å‘ç°
    priority_recommendations: list[str]    # ä¼˜å…ˆå»ºè®®

# LLM åˆ†æè¯„ä¼°æ•°æ®ï¼Œç”Ÿæˆ Executive Summary
analysis = await conv.asend(prompt, returns=LLMAnalysis)
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- ç»“åˆäº† LLM çš„è¯­ä¹‰ç†è§£èƒ½åŠ›å’Œç»“æ„åŒ–çš„å¯é æ€§
- è‡ªåŠ¨ç”Ÿæˆäººç±»å¯è¯»çš„åˆ†ææŠ¥å‘Š
- æä¾›å¯æ‰§è¡Œçš„æ”¹è¿›å»ºè®®

### 7. Mock RAG æ¨¡æ‹Ÿå®æˆ˜åœºæ™¯

ä¸ºäº†æ”¯æŒå®Œæ•´æµç¨‹æµ‹è¯•ï¼Œæä¾› Mock RAG å®ç°ï¼š

```python
async def call_mock_rag(question: str, llm_uri: str, api_key: str) -> RAGResponse:
    """ä½¿ç”¨ LLM æ¨¡æ‹Ÿ RAG ç³»ç»Ÿè¡Œä¸º"""
    system_message = """You are an expert RAG system specialized in [domain].
    Provide accurate answers and simulate retrieved context passages."""
    
    conv = Conversation(model_uri=llm_uri, system_message=system_message)
    response = await conv.asend(prompt, returns=RAGResponse)
    
    return RAGResponse(
        answer=response.answer,
        retrieved_contexts=response.retrieved_contexts
    )
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š

- åœ¨æ²¡æœ‰çœŸå® RAG ç³»ç»Ÿæ—¶ä¹Ÿèƒ½è·‘é€šå®Œæ•´æµç¨‹
- å¿«é€ŸéªŒè¯è¯„ä¼°æ¡†æ¶çš„æœ‰æ•ˆæ€§
- å¯ä½œä¸ºåŸºçº¿å¯¹æ¯”çœŸå® RAG ç³»ç»Ÿçš„è¡¨ç°

### 8. åˆ†å±‚æŠ¥å‘Šä½“ç³»

ç”Ÿæˆå¤šå±‚çº§ã€å¤šæ ¼å¼çš„è¯„ä¼°æŠ¥å‘Šï¼š

#### Markdown æŠ¥å‘Š

- Executive Summaryï¼ˆLLM ç”Ÿæˆçš„æ€»ç»“å’Œå»ºè®®ï¼‰
- Metrics Overviewï¼ˆæŒ‡æ ‡æ€»è§ˆè¡¨æ ¼ï¼‰
- Metric Detailsï¼ˆæ¯ä¸ªæŒ‡æ ‡çš„è¯¦ç»†è§£é‡Šå’Œæ”¹è¿›å»ºè®®ï¼‰
- Problem Casesï¼ˆé—®é¢˜æ¡ˆä¾‹æ·±åº¦åˆ†æï¼‰
- Excellent Casesï¼ˆä¼˜ç§€æ¡ˆä¾‹å±•ç¤ºï¼‰

#### Excel æŠ¥å‘Š

- **Metrics Summary**ï¼šå¸¦é¢œè‰²ç¼–ç çš„æŒ‡æ ‡æ€»è§ˆ
- **Performance by Query Type**ï¼šæŒ‰é—®é¢˜ç±»å‹ï¼ˆå•è·³/å¤šè·³ï¼‰åˆ†æ
- **Case Details**ï¼šå®Œæ•´æ¡ˆä¾‹æ•°æ®ï¼Œæ”¯æŒç­›é€‰å’Œæ’åº

**é¢œè‰²ç¼–ç **ï¼š

- ğŸŸ¢ ç»¿è‰²ï¼ˆAï¼‰ï¼šâ‰¥ 0.9
- ğŸŸ¢ æµ…ç»¿ï¼ˆBï¼‰ï¼šâ‰¥ 0.8
- ğŸŸ¡ é»„è‰²ï¼ˆCï¼‰ï¼šâ‰¥ 0.7
- ğŸŸ  æ©™è‰²ï¼ˆDï¼‰ï¼šâ‰¥ 0.6
- ğŸ”´ çº¢è‰²ï¼ˆFï¼‰ï¼š< 0.6

## ğŸ“Š è®¾è®¡äº®ç‚¹æ€»ç»“

| è®¾è®¡ç»´åº¦ | æ ¸å¿ƒæ€æƒ³ | ä¸»è¦ä¼˜åŠ¿ |
|----------|----------|----------|
| **æ•°æ®é—­ç¯** | ä»åˆæˆåˆ°è¯„ä¼°åˆ°æŠ¥å‘Šï¼Œå…¨æµç¨‹è‡ªåŠ¨åŒ– | å‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜æ•ˆç‡ |
| **æ•°æ®ç‹¬ç«‹æ€§** | Self-contained EvalCaseï¼Œæ— å¤–éƒ¨ä¾èµ– | æ•°æ®å¯ç§»æ¤ã€å¯å¤ç° |
| **åœºæ™¯å¤šæ ·æ€§** | Persona Ã— ä¸»é¢˜ Ã— å•å…ƒç»„åˆ | é¿å…é‡å¤ï¼Œè¦†ç›–çœŸå®åœºæ™¯ |
| **è´¨é‡ä¿è¯** | å¤šæŒ‡æ ‡è¯„ä¼° + LLM åˆ†æ | å…¨é¢è¯Šæ–­ + å¯æ‰§è¡Œå»ºè®® |
| **çµæ´»æ€§** | æ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰ç»„ä»¶ | æ˜“æ‰©å±•ã€æ˜“å®šåˆ¶ |
| **å®æˆ˜å¯¼å‘** | Mock RAG + å®Œæ•´æµç¨‹æµ‹è¯• | å¯å¿«é€ŸéªŒè¯å’Œè¿­ä»£ |

## ğŸ“ è®¾è®¡å“²å­¦

### è¯„ä¼°å³å¼€å‘

zeval å°†è¯„ä¼°è§†ä¸º RAG å¼€å‘çš„æ ¸å¿ƒç¯èŠ‚ï¼Œè€Œéäº‹åæ£€æŸ¥ï¼š

1. **å¿«é€Ÿè¿­ä»£**ï¼šè‡ªåŠ¨ç”Ÿæˆè¯„ä¼°æ•°æ®ï¼Œæ— éœ€äººå·¥æ ‡æ³¨
2. **ç²¾å‡†å®šä½**ï¼šå¤šæŒ‡æ ‡çŸ©é˜µå¿«é€Ÿå®šä½é—®é¢˜
3. **æ•°æ®é©±åŠ¨**ï¼šåŸºäºè¯„ä¼°ç»“æœä¼˜åŒ–ç³»ç»Ÿ

### å¯è¿½æº¯æ€§ä¼˜å…ˆ

æ¯ä¸ªè¯„ä¼°æ¡ˆä¾‹éƒ½ä¿ç•™å®Œæ•´çš„ç”Ÿæˆè¿‡ç¨‹ï¼š

- æºæ–‡æ¡£çš„å“ªä¸ªç‰‡æ®µï¼Ÿ
- ä½¿ç”¨äº†ä»€ä¹ˆè§’è‰²ï¼Ÿ
- ä¸»é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
- ç”Ÿæˆå‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿ

è¿™äº›ä¿¡æ¯åœ¨åˆ†æé—®é¢˜æ¡ˆä¾‹æ—¶è‡³å…³é‡è¦ã€‚

### é¢†åŸŸé€‚é…æ€§

é€šè¿‡ Persona æœºåˆ¶å’Œè‡ªå®šä¹‰ç»„ä»¶ï¼Œzeval å¯é€‚é…ä¸åŒé¢†åŸŸï¼š

- é‡‘èï¼šä¿¡è´·è¯„ä¼°ã€æŠ•èµ„å’¨è¯¢
- åŒ»ç–—ï¼šè¯Šæ–­è¾…åŠ©ã€è¯ç‰©å’¨è¯¢
- æ³•å¾‹ï¼šåˆåŒåˆ†æã€åˆ¤ä¾‹æ£€ç´¢
- æ•™è‚²ï¼šçŸ¥è¯†é—®ç­”ã€å­¦ä¹ è¾…å¯¼

## ğŸ“š å‚è€ƒç¤ºä¾‹

å®Œæ•´çš„ç«¯åˆ°ç«¯ç¤ºä¾‹è¯·å‚è€ƒï¼š

- `examples/test_e2e_complete.py` - å®Œæ•´ E2E æµç¨‹
- `examples/test_single_hop.py` - å•è·³é—®ç­”ç”Ÿæˆ
- `examples/test_multi_hop.py` - å¤šè·³é—®ç­”ç”Ÿæˆ
- `examples/test_runner_all_metrics.py` - å¤šæŒ‡æ ‡è¯„ä¼°
- `examples/test_reporter.py` - æŠ¥å‘Šç”Ÿæˆ

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*æœ€åæ›´æ–°ï¼š2026-01-13*
